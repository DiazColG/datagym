<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workout Activo - DataGym</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="workout-activo.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="workout-active-body">
    <div class="workout-header-bar">
        <div class="header-left">
            <button class="btn-back-workout" id="btnBackWorkout">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="workout-title">
                <h2 id="workoutTitle">Cargando...</h2>
                <span id="workoutSubtitle" class="workout-subtitle"></span>
            </div>
        </div>
        <div class="workout-timer" id="workoutTimer">
            <i class="fas fa-clock"></i>
            <span id="timerDisplay">00:00</span>
        </div>
    </div>

    <div class="workout-main-content">
        <div class="exercise-progress-bar">
            <div class="progress-info">
                <span>Ejercicio <strong id="currentExerciseNum">1</strong> de <strong id="totalExercisesNum">5</strong></span>
            </div>
            <div class="progress-track">
                <div class="progress-fill-bar" id="progressFillBar"></div>
            </div>
        </div>

        <div class="current-exercise-card" id="currentExerciseCard">
            <div class="exercise-header-info">
                <div class="exercise-icon-name">
                    <span class="exercise-emoji" id="exerciseEmoji">üí™</span>
                    <div>
                        <h3 id="exerciseName">Press de Banca</h3>
                        <p id="exerciseMuscle">PECHO</p>
                    </div>
                </div>
                <div class="previous-data" id="previousDataBox">
                    <i class="fas fa-history"></i>
                    <div>
                        <small>√öltima vez</small>
                        <strong id="previousBest">80kg √ó 10</strong>
                    </div>
                </div>
            </div>

            <div class="sets-tracker" id="setsTracker"></div>

            <div class="current-set-panel" id="currentSetPanel">
                <div class="set-number-badge">
                    <span>Serie</span>
                    <strong id="currentSetNumber">1</strong>
                </div>

                <div class="weight-selector">
                    <h4>Peso (kg)</h4>
                    <div class="weight-controls">
                        <button class="btn-weight-adj" data-change="-5">-5</button>
                        <button class="btn-weight-adj" data-change="-2.5">-2.5</button>
                        <div class="weight-display" id="weightDisplay">0</div>
                        <button class="btn-weight-adj" data-change="2.5">+2.5</button>
                        <button class="btn-weight-adj" data-change="5">+5</button>
                    </div>
                    <input type="number" id="weightInput" class="weight-input-direct" placeholder="0" step="0.5">
                </div>

                <div class="reps-selector">
                    <h4>Repeticiones</h4>
                    <div class="reps-grid" id="repsGrid"></div>
                    <input type="number" id="repsInput" class="reps-input-direct" placeholder="0" min="1" max="50">
                </div>

                <button class="btn-complete-set" id="btnCompleteSet">
                    <i class="fas fa-check-circle"></i>
                    Completar Serie
                </button>
            </div>

            <div class="exercise-navigation">
                <button class="btn-nav-exercise" id="btnPrevExercise" disabled>
                    <i class="fas fa-chevron-left"></i>
                    Anterior
                </button>
                <button class="btn-nav-exercise primary" id="btnNextExercise">
                    Siguiente
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div class="workout-notes-section">
            <textarea id="workoutNotes" placeholder="Notas del entrenamiento..."></textarea>
        </div>

        <div class="workout-actions-footer">
            <button class="btn-finish-workout" id="btnFinishWorkout">
                <i class="fas fa-flag-checkered"></i>
                Finalizar Entrenamiento
            </button>
        </div>
    </div>

    <div class="modal-overlay" id="modalFinishWorkout">
        <div class="modal-content-finish">
            <div class="modal-icon-success">
                <i class="fas fa-trophy"></i>
            </div>
            <h2>¬°Entrenamiento Completado!</h2>
            <div class="workout-summary" id="workoutSummary">
                <div class="summary-stat">
                    <i class="fas fa-clock"></i>
                    <div>
                        <strong id="summaryDuration">45 min</strong>
                        <span>Duraci√≥n</span>
                    </div>
                </div>
                <div class="summary-stat">
                    <i class="fas fa-weight-hanging"></i>
                    <div>
                        <strong id="summaryVolume">5,240 kg</strong>
                        <span>Volumen Total</span>
                    </div>
                </div>
                <div class="summary-stat">
                    <i class="fas fa-fire"></i>
                    <div>
                        <strong id="summaryCalories">320 kcal</strong>
                        <span>Calor√≠as</span>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" id="btnCancelFinish">Volver</button>
                <button class="btn btn-success btn-large" id="btnConfirmFinish">
                    <i class="fas fa-check"></i> Confirmar
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { auth } from './firebase-config.js';
        import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { iniciarWorkout, completarSerie, finalizarWorkout, obtenerWorkout } from './workout-manager.js';
        import { obtenerRutina, incrementarVecesCompletada } from './rutinas-manager.js';
        import { EXERCISES_DB } from './exercises-db.js';

        let userActual = null;
        let workoutActual = null;
        let workoutId = null;
        let rutinaActual = null;
        let ejercicioActualIdx = 0;
        let serieActualIdx = 0;
        let pesoActual = 0;
        let repsActuales = 0;
        let tiempoInicio = null;
        let timerInterval = null;

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userActual = user;
                await inicializarWorkout();
            } else {
                window.location.href = 'auth.html';
            }
        });

        async function inicializarWorkout() {
            const workoutType = localStorage.getItem('workoutType');
            const routineId = localStorage.getItem('selectedRoutineId');

            try {
                if (workoutType === 'routine' && routineId) {
                    rutinaActual = await obtenerRutina(userActual.uid, routineId);
                    workoutId = await iniciarWorkout(userActual.uid, routineId, rutinaActual);
                } else {
                    workoutId = await iniciarWorkout(userActual.uid, null, { nombre: 'Workout R√°pido', ejercicios: [] });
                }

                workoutActual = await obtenerWorkout(userActual.uid, workoutId);
                tiempoInicio = new Date();
                
                configurarInterfaz();
                iniciarTimer();
                renderizarEjercicioActual();
            } catch (error) {
                console.error('Error iniciando workout:', error);
                alert('Error al iniciar el entrenamiento');
                window.location.href = 'entrenar.html';
            }
        }

        function configurarInterfaz() {
            document.getElementById('workoutTitle').textContent = workoutActual.nombreRutina;
            document.getElementById('workoutSubtitle').textContent = `${workoutActual.ejercicios.length} ejercicios`;
            document.getElementById('totalExercisesNum').textContent = workoutActual.ejercicios.length;

            document.getElementById('btnBackWorkout').addEventListener('click', () => {
                if (confirm('¬øSalir sin guardar el entrenamiento?')) {
                    window.location.href = 'entrenar.html';
                }
            });

            document.getElementById('btnCompleteSet').addEventListener('click', completarSerieActual);
            document.getElementById('btnPrevExercise').addEventListener('click', ejercicioAnterior);
            document.getElementById('btnNextExercise').addEventListener('click', ejercicioSiguiente);
            document.getElementById('btnFinishWorkout').addEventListener('click', mostrarModalFinalizar);
            document.getElementById('btnCancelFinish').addEventListener('click', cerrarModalFinalizar);
            document.getElementById('btnConfirmFinish').addEventListener('click', confirmarFinalizacion);

            document.querySelectorAll('.btn-weight-adj').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const cambio = parseFloat(e.currentTarget.dataset.change);
                    ajustarPeso(cambio);
                });
            });

            document.getElementById('weightInput').addEventListener('input', (e) => {
                pesoActual = parseFloat(e.target.value) || 0;
                actualizarDisplayPeso();
            });

            document.getElementById('repsInput').addEventListener('input', (e) => {
                repsActuales = parseInt(e.target.value) || 0;
            });

            renderizarBotonesReps();
        }

        function renderizarBotonesReps() {
            const grid = document.getElementById('repsGrid');
            const botones = [];
            for (let i = 1; i <= 15; i++) {
                botones.push(`<button class="btn-rep" data-reps="${i}">${i}</button>`);
            }
            grid.innerHTML = botones.join('');

            grid.querySelectorAll('.btn-rep').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    repsActuales = parseInt(e.currentTarget.dataset.reps);
                    document.getElementById('repsInput').value = repsActuales;
                    grid.querySelectorAll('.btn-rep').forEach(b => b.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                });
            });
        }

        function iniciarTimer() {
            timerInterval = setInterval(() => {
                const ahora = new Date();
                const diff = ahora - tiempoInicio;
                const minutos = Math.floor(diff / 60000);
                const segundos = Math.floor((diff % 60000) / 1000);
                document.getElementById('timerDisplay').textContent = 
                    `${String(minutos).padStart(2, '0')}:${String(segundos).padStart(2, '0')}`;
            }, 1000);
        }

        function renderizarEjercicioActual() {
            if (!workoutActual.ejercicios || workoutActual.ejercicios.length === 0) {
                document.getElementById('currentExerciseCard').innerHTML = 
                    '<div class="empty-state"><p>No hay ejercicios en este workout</p></div>';
                return;
            }

            const ejercicio = workoutActual.ejercicios[ejercicioActualIdx];
            const datosEjercicio = EXERCISES_DB.find(e => e.id === ejercicio.exerciseId);

            document.getElementById('currentExerciseNum').textContent = ejercicioActualIdx + 1;
            document.getElementById('exerciseEmoji').textContent = datosEjercicio?.icono || 'üí™';
            document.getElementById('exerciseName').textContent = datosEjercicio?.nombre || ejercicio.nombreEjercicio;
            document.getElementById('exerciseMuscle').textContent = datosEjercicio?.grupoMuscular.toUpperCase() || '';

            actualizarProgressBar();
            renderizarSeries();
            actualizarBotonesNavegacion();
        }

        function renderizarSeries() {
            const ejercicio = workoutActual.ejercicios[ejercicioActualIdx];
            const tracker = document.getElementById('setsTracker');
            
            tracker.innerHTML = ejercicio.series.map((serie, idx) => {
                let estadoClass = 'pending';
                let icono = '‚è≥';
                
                if (serie.completado) {
                    estadoClass = 'completed';
                    icono = '‚úÖ';
                } else if (idx === serieActualIdx) {
                    estadoClass = 'current';
                    icono = 'üîµ';
                }

                return `
                    <div class="set-badge ${estadoClass}">
                        <div class="set-badge-icon">${icono}</div>
                        <div class="set-badge-num">S${serie.set}</div>
                        ${serie.completado ? `<div class="set-badge-data">${serie.peso}kg √ó ${serie.reps}</div>` : ''}
                    </div>
                `;
            }).join('');
        }

        function ajustarPeso(cambio) {
            pesoActual = Math.max(0, pesoActual + cambio);
            actualizarDisplayPeso();
            document.getElementById('weightInput').value = pesoActual;
        }

        function actualizarDisplayPeso() {
            document.getElementById('weightDisplay').textContent = pesoActual.toFixed(1);
        }

        async function completarSerieActual() {
            if (repsActuales === 0) {
                alert('Ingresa las repeticiones realizadas');
                return;
            }

            try {
                await completarSerie(userActual.uid, workoutId, ejercicioActualIdx, serieActualIdx, {
                    reps: repsActuales,
                    peso: pesoActual
                });

                workoutActual = await obtenerWorkout(userActual.uid, workoutId);
                
                const ejercicio = workoutActual.ejercicios[ejercicioActualIdx];
                const siguienteSerieIncompleta = ejercicio.series.findIndex((s, idx) => idx > serieActualIdx && !s.completado);
                
                if (siguienteSerieIncompleta !== -1) {
                    serieActualIdx = siguienteSerieIncompleta;
                    renderizarSeries();
                    document.getElementById('currentSetNumber').textContent = serieActualIdx + 1;
                } else {
                    if (ejercicioActualIdx < workoutActual.ejercicios.length - 1) {
                        ejercicioSiguiente();
                    } else {
                        alert('¬°Has completado todos los ejercicios!');
                    }
                }
            } catch (error) {
                console.error('Error completando serie:', error);
                alert('Error al guardar la serie');
            }
        }

        function ejercicioAnterior() {
            if (ejercicioActualIdx > 0) {
                ejercicioActualIdx--;
                serieActualIdx = 0;
                resetearInputs();
                renderizarEjercicioActual();
            }
        }

        function ejercicioSiguiente() {
            if (ejercicioActualIdx < workoutActual.ejercicios.length - 1) {
                ejercicioActualIdx++;
                serieActualIdx = 0;
                resetearInputs();
                renderizarEjercicioActual();
            }
        }

        function resetearInputs() {
            pesoActual = 0;
            repsActuales = 0;
            document.getElementById('weightInput').value = '';
            document.getElementById('repsInput').value = '';
            actualizarDisplayPeso();
            document.querySelectorAll('.btn-rep').forEach(b => b.classList.remove('active'));
        }

        function actualizarBotonesNavegacion() {
            const btnPrev = document.getElementById('btnPrevExercise');
            const btnNext = document.getElementById('btnNextExercise');
            
            btnPrev.disabled = ejercicioActualIdx === 0;
            btnNext.disabled = ejercicioActualIdx === workoutActual.ejercicios.length - 1;
        }

        function actualizarProgressBar() {
            const porcentaje = ((ejercicioActualIdx + 1) / workoutActual.ejercicios.length) * 100;
            document.getElementById('progressFillBar').style.width = `${porcentaje}%`;
        }

        function mostrarModalFinalizar() {
            const ahora = new Date();
            const duracionMs = ahora - tiempoInicio;
            const minutos = Math.floor(duracionMs / 60000);
            
            document.getElementById('summaryDuration').textContent = `${minutos} min`;
            document.getElementById('summaryVolume').textContent = '0 kg';
            document.getElementById('summaryCalories').textContent = '0 kcal';
            
            document.getElementById('modalFinishWorkout').classList.add('active');
        }

        function cerrarModalFinalizar() {
            document.getElementById('modalFinishWorkout').classList.remove('active');
        }

        async function confirmarFinalizacion() {
            try {
                const notas = document.getElementById('workoutNotes').value;
                await finalizarWorkout(userActual.uid, workoutId, notas);
                
                if (rutinaActual) {
                    await incrementarVecesCompletada(userActual.uid, localStorage.getItem('selectedRoutineId'));
                }
                
                clearInterval(timerInterval);
                localStorage.removeItem('workoutType');
                localStorage.removeItem('selectedRoutineId');
                
                window.location.href = 'index.html';
            } catch (error) {
                console.error('Error finalizando workout:', error);
                alert('Error al finalizar el entrenamiento');
            }
        }
    </script>
</body>
</html>
